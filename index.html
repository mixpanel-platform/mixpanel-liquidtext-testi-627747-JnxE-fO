<!doctype html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
		<link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
		<script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
		<title>Mixpanel Platform</title>
	</head>
	<body class="mixpanel-platform-body">

		<h1><font size="18">LiquidText!</font></h1>

		<div id="datePicker"></div>
		
		<br><br>
		<div id="eventSelect"></div>
		<div id = "barChart"> <table style="width:100%"></table></div>

		<script>

		 var barchart = $('#barChart').MPChart({
        chartType: 'bar' 
       });
		var dateSelector = $('#datePicker').MPDatepicker();
    var eventSelect = $('#eventSelect').MPEventSelect();
    
      	var segObject
      	var chartData = {}

      	var segProperty = "UserID";
      	var dateRange = dateSelector.MPDatepicker('value')
      	var eventName = "app.app-launch"

      	var getSegData = new Promise(function(resolve, reject) {
      		MP.api.segment(eventName, segProperty, dateRange).done(function(segData) {
      			resolve(segData)
      		})
      	})

    getSegData.then(function(segData) {
      segObject = segData.sum().values()

			var peoplePromises = []      		

      		for (var user in segObject) {

      			var whereParam = '("'+user+'" in properties["$first_name"])'
      			// console.log(whereParam)

      			var peoplePromise = new Promise(function(resolve, reject) {
      				MP.api.people({where: whereParam}).done(function(userProfile) {
      					resolve(userProfile)
      				})
      			})

      			peoplePromises.push(peoplePromise)
      			
      		}

      	Promise.all(peoplePromises).then(function(peopleData) {

      		for (var user in peopleData) {
      			var firstName = peopleData[user].values().results[0]["$properties"]["$first_name"]
      			var distinctId = peopleData[user].values().results[0]["$distinct_id"]
      			
      			chartData[firstName] = segObject[distinctId]

      		}
      		
          console.log(chartData);
          var sortedFinalData = [];
          var sortedPromise = [];
          var sortedDataPromise = new Promise(function (resolve, reject){
            var length = Object.keys(chartData).length;
            for (var i = 0; i < length; i++){
              var maxAmount = _.max(chartData);
              var maxUser = _.invert(chartData)[_.max(chartData)]
              console.log(maxUser);
              sortedFinalData[maxUser] = chartData[maxUser];
              delete chartData[maxUser];
            }
            sortedPromise.push(sortedDataPromise)
          })
          
          Promise.all(sortedPromise)(function(sortedData){
            barchart.MPChart('setData', sortedData);
          })
          
      	})
      })


		</script>
	</body>
</html>